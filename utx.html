<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Trip Ticket - Deployable Web Form</title>
    
    <!-- Bootstrap 5.3.3 (Latest stable as of Dec 2025) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Signature Pad Official v4.2.0 -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>

    <!-- html2canvas v1.4.1 (still best choice) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- jsPDF v2.5.1 (current stable) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
        body { padding: 20px; background: #f5f5f5; font-family: system-ui, sans-serif; }
        .card { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .signature-pad { 
            border: 2px solid #444; 
            border-radius: 8px; 
            background: #fff; 
            width: 100%; 
            height: 160px; 
            touch-action: none;
        }
        .form-label { font-weight: 600; color: #333; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .signature-pad { height: 120px; }
            .btn { font-size: 1.1rem; padding: 0.75rem 1rem; }
        }
    </style>
</head>
<body>
    <div class="container bg-white rounded-3 shadow-lg p-4">
        <header class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">Ultimate Trip Ticket</h1>
            <p class="text-muted">Complete digital trip log with signatures</p>
        </header>

        <form id="tripForm" class="needs-validation" novalidate 
              action="https://formspree.io/f/YOUR_FORMSPREE_ID" method="POST">
            
            <!-- Office Use Only -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title text-danger... wait, no → Office Use Only</h2>
                    <div class="row">
                        <div class="col-lg-8">
                            <label class="form-label">ATT/Accounts Coordinator Signature</label>
                            <canvas id="officeSig" class="signature-pad"></canvas>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="sigs.office.clear()">Clear</button>
                            </div>
                            <input type="hidden" name="office_signature" id="officeSigData">
                        </div>
                        <div class="col-lg-4 d-flex align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="applicableForm" name="applicable_form">
                                <label class="form-check-label" for="applicableForm">Applicable Form for Email</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Details -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Client Details</h2>
                    <div class="row g-3">
                        <div class="col-md-6"><label>Client Name <span class="text-danger">*</span></label><input type="text" class="form-control" name="client_name" required></div>
                        <div class="col-md-6"><label>Dept/Sales</label><input type="text" class="form-control" name="dept_sales"></div>
                        <div class="col-md-3"><label>Booking Code</label><input type="text" class="form-control" name="booking_code"></div>
                        <div class="col-md-3"><label>Request Code</label><input type="text" class="form-control" name="request_code"></div>
                        <div class="col-md-4"><label>Name/Table</label><input type="text" class="form-control" name="name_table"></div>
                        <div class="col-md-4"><label>Cost Centre</label><input type="text" class="form-control" name="cost_centre"></div>
                        <div class="col-md-4"><label>Dept</label><input type="text" class="form-control" name="dept"></div>
                    </div>
                </div>
            </div>

            <!-- Trip Log -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Trip Log</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tripTable">
                            <thead class="table-light">
                                <tr><th>#</th><th>Time</th><th>Location / Details</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <label>Total Completed Trips:</label>
                        <input type="number" class="form-control w-auto d-inline-block ms-2" style="width:80px;" name="total_trips" readonly value="0">
                    </div>
                </div>
            </div>

            <!-- Driver Certification -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Driver Certification</h2>
                    <p>I certify that the above trip(s) were completed as requested.</p>
                    <div class="row">
                        <div class="col-lg-8">
                            <label class="form-label">Driver Signature</label>
                            <canvas id="driverSig" class="signature-pad"></canvas>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="sigs.driver.clear()">Clear</button>
                            <input type="hidden" name="driver_signature" id="driverSigData">
                        </div>
                        <div class="col-lg-4">
                            <label>Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="driver_date" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Correspondence -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Other Correspondence</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light"><tr><th>Date</th><th>Time</th><th>Location</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td><input type="date" class="form-control" name="corr_date1"></td>
                                    <td><input type="time" class="form-control" name="corr_time1"></td>
                                    <td><input type="text" class="form-control" name="corr_loc1"></td>
                                    <td><input type="text" class="form-control" name="corr_desc1"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="row mt-3">
                        <div class="col-lg-8">
                            <label>Signature</label>
                            <canvas id="corrSig" class="signature-pad"></canvas>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="sigs.corr.clear()">Clear</button>
                            <input type="hidden" name="corr_signature" id="corrSigData">
                        </div>
                        <div class="col-lg-4">
                            <label>Date</label>
                            <input type="date" class="form-control" name="corr_date">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Confirmation -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Client Confirmation</h2>
                    <p>I confirm the above trip(s) were completed as requested.</p>
                    <div class="row">
                        <div class="col-lg-8">
                            <label class="form-label">Client Signature</label>
                            <canvas id="clientSig" class="signature-pad"></canvas>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="sigs.client.clear()">Clear</button>
                            <input type="hidden" name="client_signature" id="clientSigData">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6"><label>Name <span class="text-danger">*</span></label><input type="text" class="form-control" name="client_name_confirm" required></div>
                        <div class="col-md-6"><label>Date <span class="text-danger">*</span></label><input type="date" class="form-control" name="client_date" required></div>
                    </div>
                </div>
            </div>

            <!-- Other Details -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h4 card-title">Additional Information</h2>
                    <div class="row g-3">
                        <div class="col-12"><label>PAX Names</label><textarea class="form-control" name="pax_names" rows="2"></textarea></div>
                        <div class="col-md-4"><label>PAX Count</label><input type="number" class="form-control" name="pax" min="1"></div>
                        <div class="col-md-4"><label class="form-label d-block">NO TAX</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="no_tax" id="noTax">
                                <label class="form-check-label" for="noTax">Tax Exempt</label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label>Billing Options</label>
                        <div class="d-flex flex-wrap gap-3">
                            ["Per Trip", "Non-Contract", "Adhoc", "Contract", "Per Day", "Driver", "User", "Delivery Docket", "Other"].forEach(opt => {
                                document.write(`
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="billing" value="${opt}" id="bill${opt.replace(/[^a-z]/gi,'')}">
                                    <label class="form-check-label" for="bill${opt.replace(/[^a-z]/gi,'')}">${opt}</label>
                                </div>`);
                            });
                        </script>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label>Refer to Contract / SLA / Etc.</label>
                        <textarea class="form-control" name="refer_to" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-primary btn-lg px-5">Submit via Email</button>
                <button type="button" class="btn btn-success btn-lg px-5 ms-3" onclick="downloadPDF()">Download PDF</button>
            </div>
        </form>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Signature pads using official Signature Pad library
        const sigs = {
            office: new SignaturePad(document.getElementById('officeSig')),
            driver: new SignaturePad(document.getElementById('driverSig')),
            corr:   new SignaturePad(document.getElementById('corrSig')),
            client: new SignaturePad(document.getElementById('clientSig'))
        };

        // Resize canvases properly
        function resizeCanvas(canvas) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            return canvas;
        }
        Object.values(sigs).forEach(pad => resizeCanvas(pad._canvas));
        window.addEventListener('resize', () => Object.values(sigs).forEach(pad => resizeCanvas(pad._canvas)));

        // Add 16 trip rows
        const tbody = document.querySelector('#tripTable tbody');
        for (let i = 1; i <= 16; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center fw-bold">${i}</td>
                <td><input type="time" class="form-control" name="time${i}"></td>
                <td><input type="text" class="form-control" name="loc${i}" placeholder="From → To or details"></td>
            `;
            tbody.appendChild(tr);
        }

        // Update total trips counter
        function updateTotalTrips() {
            let count = 0;
            for (let i = 1; i <= 16; i++) {
                const time = document.querySelector(`[name="time${i}"]`).value;
                const loc = document.querySelector(`[name="loc${i}"]`).value;
                if (time || loc) count++;
            }
            document.querySelector('[name="total_trips"]').value = count;
        }
        document.querySelectorAll('#tripTable input').forEach(inp => inp.addEventListener('input', updateTotalTrips));

        // Form submit: embed signatures + total trips
        document.getElementById('tripForm').addEventListener('submit', function(e) {
            if (!this.checkValidity()) {
                e.preventDefault();
                this.classList.add('was-validated');
                return;
            }

            // Embed signatures as base64
            document.getElementById('officeSigData').value = sigs.office.toDataURL();
            document.getElementById('driverSigData').value = sigs.driver.toDataURL();
            document.getElementById('corrSigData').value = sigs.corr.toDataURL();
            document.getElementById('clientSigData').value = sigs.client.toDataURL();

            updateTotalTrips();
        });

        // PDF Download - multi-page, high quality
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.body;

            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                windowWidth: document.documentElement.offsetWidth,
                windowHeight: document.documentElement.offsetHeight
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = 0;

            if (imgHeight * ratio > pdfHeight) {
                // Multi-page PDF
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', imgX, position, imgWidth * ratio, imgHeight * ratio);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', imgX, position * ratio, imgWidth * ratio, imgHeight * ratio);
                    heightLeft -= pdfHeight;
                }
            } else {
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            }

            pdf.save('Ultimate_Trip_Ticket_' + new Date().toISOString().slice(0,10) + '.pdf');
        }
    </script>
</body>
</html>
